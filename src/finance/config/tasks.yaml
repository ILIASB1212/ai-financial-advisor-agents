client_profile_task:
  description: >
    Analyze the provided client intake data for the stated **Investment Goal**. 
    Extract client budget, timeline, risk tolerance, sector preferences, and investment strategy.
    
    **CRITICAL:** You must output ONLY a valid JSON object with no additional text before or after.
  
  expected_output: >
    A single, complete **JSON object** (no prose before or after) containing the client's verified profile data. 
    The document must include the following mandatory keys:
    
    ```json
    {
      "client_budget": "string (e.g., '$100,000')",
      "timeline_in_years": "integer (e.g., 5)",
      "verified_risk_tolerance_score": "integer (1-10 scale)",
      "sector_preferences": "array of strings (e.g., ['Sectore 1', 'Sectore 2',.........])",
      "investment_strategy": "string (e.g., 'Growth Investing')",
    }
    ```
    
  agent: Client_Profiler


market_research_task:
  description: >
    Your mission is to leverage the full, structured **Client Profile Summary** JSON (received from the Client Profiler) 
    to conduct a targeted, actionable market and sector analysis. This analysis must bridge the client's financial goals 
    with current market realities.
    
    Your core objective is to identify and analyze the **most suitable equity sectors** that logically support the client's 
    defined **primary_goal_type**, **verified_risk_tolerance_score**, and any specific **strategy_preference** or 
    **implicit_constraints**.
    
    Your specific, mandatory process steps are:

    1.  **Sector Identification and Justification:**
        * **Primary Filter:** Scrutinize the goal type (e.g., 'Aggressive Wealth Accumulation', 'Dividend Stock Focus') 
          and sector preferences. Identify and select the most relevant GICS sectors**.
        * **Risk-Based Fallback:** If sector preference is ambiguous, use the **verified_risk_tolerance_score** and 
          timeline_years to justify the selection. (e.g., High Risk/Long Timeline = Growth Sectors; Low Risk/Short Timeline = 
          Defensive/Value Sectors). **The justification for sector choice must be explicit in your notes.**

    2.  **Deep Market & Company Intelligence Gathering:**
        * **Quantitative Metrics:** For each identified sector, gather and report key current performance indicators, 
          including **Year-to-Date (YTD) Return**, the sector's **Forward P/E Ratio**, and the **Volatility Index (Beta)** 
          relative to the S&P 500.
        * **Qualitative Drivers:** Conduct targeted searches for **major recent news events** (past 180 days), regulatory 
          changes, and significant macro trends (e.g., inflation impact, supply chain shifts) that are currently driving 
          the sector's valuation.

    3.  **Synthesized Market Outlook and Risk Assessment:**
        * Based on the quantitative data and qualitative drivers, generate a comprehensive **6-Month Market Outlook** for 
          each sector. This outlook must include potential **upside/downside scenarios** and a final, clear **Sentiment Rating** 
          (BULLISH/BEARISH/NEUTRAL).
        * Identify and articulate the primary **risk factor** disclosed in the client profile and analyze how the chosen 
          sectors mitigate or amplify that specific risk.
  
  expected_output: >
    A comprehensive, professional **Targeted Sector Research Brief** structured for immediate use by the Investment Strategist. 
    The output must be formatted with clear headings, adhering strictly to the following two sections:
    
    ## 1. Client-Sector Alignment Summary
    
    A concise opening paragraph (4-6 sentences) that:
    - Clearly states the chosen sectors
    - Explicitly justifies the selection based on the client's profile data
    - Provides the overall weighted market sentiment (BULLISH/BEARISH/NEUTRAL) across all selected sectors
    
    ## 2. Sector Deep Dive
    
    For EACH identified sector, provide a dedicated paragraph with:
    
    **[Sector Name]**
    - **YTD Return:** X%
    - **Forward P/E Ratio:** X.X
    - **Sector Beta:** X.X
    - **Recent Drivers:** [2-3 sentence summary of news/trends]
    - **6-Month Outlook:** [Detailed 3-4 sentence analysis]
    - **Sentiment:** BULLISH/BEARISH/NEUTRAL
    - **Risk Alignment:** [How this sector addresses client's risk profile]
    
  agent: Market_Research_Analyst


Quantitative_Defensive_Stock_Filtering:
  description: >
    Your mission is to perform a rigorous **Quantitative Stock Filtering** analysis tailored to the client's profile. 
    You must utilize the **Research Brief** (sectors and sentiment) to identify a concentrated list of high-quality candidates.

    **CRITICAL ADAPTATION:** The filtering criteria must be dynamically set based on the client's **'primary_goal_type'** 
    and **'verified_risk_tolerance_score'** (from the Client Profile JSON):
    
    * **If Goal is 'Aggressive Wealth Accumulation' (Growth Focus):** 
      - Prioritize **Revenue Growth Rate > 15% annually**
      - **Market Position** (Top 3 in sector)
      - **High Free Cash Flow** (FCF growth > 10% over 3 years)
      - Beta > 1.0 is acceptable and desired
      - P/E ratio can be elevated if justified by growth
    
    * **If Goal is 'Capital Preservation' (Defensive Focus):** 
      - Prioritize **Low Volatility (Beta < 1.0)**
      - **Dividend Stability** (5+ consecutive years of growth)
      - **D/E Ratio below Sector Average**
      - Consistent positive FCF
      - Moderate P/E ratios
    
    You must apply the appropriate quantitative criteria to identify **5-7 candidates** from the researched sectors.
    
    **Data Sources:** Use your financial tools to gather:
    - Current stock prices
    - Beta values
    - 3-year FCF trend data
    - Debt-to-Equity ratios vs sector averages
    - Dividend growth history
    - P/E ratios
  
  expected_output: >
    A final, comprehensive **Markdown table** listing the **5-7 Best-Qualified Stock Candidates** from the analyzed sectors. 
    
    The table must include the following mandatory columns for each candidate:
    
    | Ticker | Stock Name | Sector | Beta | FCF Trend (3Y) | D/E vs Sector Avg | Dividend Growth (Yrs) | P/E Ratio | Quantitative Justification |
    | :--- | :--- | :--- | :---: | :---: | :---: | :---: | :---: | :--- |
    | AAPL | company name. | Sectore | float | percentage | Below | int | float | Strong FCF growth, market leader, consistent dividend |
    
    **The Quantitative Justification column must:**
    - Be 1-2 sentences
    - State how the candidate satisfies the criteria aligned with the client's specific goal (Growth or Defensive)
    - Reference specific metrics from the table
    
  agent: Financial_Data_Analyst
  context:
    - market_research_task


Qualitative_and_External_Risk_Assessment:
  description: >
    Your mission is to execute a rigorous **Qualitative and External Risk Vetting** on the final list of 5-7 quantitatively 
    stable stock candidates provided in the **Markdown table** from the Financial Data Analyst. You must use your specialized 
    tools to transform a quantitatively sound list into a truly **risk-vetted final portfolio**.

    Your analysis must cover the following critical non-quantitative risk domains for *every* stock candidate:

    1.  **Idiosyncratic Risks (SEC Hercules & Search Tool):**
        * Investigate the candidate's name and ticker for pending or recent litigation, major product recalls, and material 
          ethical/governance scandals over the last **12 months**.
        * Utilize the **SEC Hercules Tool** with keywords like 'litigation', 'recall', 'scandal', or 'investigation' to 
          check formal risk disclosures in recent 10-K/8-K filings.

    2.  **Supply Chain & Geopolitical Vulnerability (Search Tool):**
        * Assess significant dependencies or risks related to raw material cost fluctuations, exposure to tariffs, or major 
          supply chain vulnerabilities stemming from **geopolitical instability** (e.g., specific regions, trade wars, 
          China-Taiwan tensions).

    3.  **Regulatory Headwinds (Search Tool):**
        * Identify upcoming or recent changes in key sector legislation, commodity tariffs, antitrust actions, or tax policy 
          that could materially and negatively impact the candidate's future earnings or market access.
    
    **Scoring Guidance:**
    - **9-10:** Minimal qualitative risks; clean governance; diversified supply chain
    - **7-8:** Minor risks present but manageable; well-disclosed
    - **5-6:** Moderate risks requiring monitoring (e.g., single-region dependency)
    - **3-4:** Significant risks (e.g., active litigation, regulatory scrutiny)
    - **1-2:** High/severe risks (e.g., major scandal, critical supply disruption)
  
  expected_output: >
    A final, comprehensive **Markdown table** suitable for the Investment Strategist. This table must be a direct revision 
    of the Financial Data Analyst's input table, incorporating all original quantitative columns PLUS the following two new 
    columns for each stock:

    | Ticker | Stock Name | Sector | Beta | FCF Trend (3Y) | D/E vs Sector Avg | Dividend Growth (Yrs) | P/E Ratio | Quantitative Justification | Major Qualitative Risks | Final Risk Suitability Score (1-10) |
    | :--- | :--- | :--- | :---: | :---: | :---: | :---: | :---: | :--- | :--- | :---: |

    **Requirements:**
    
    * **Major Qualitative Risks:** Must contain a brief, actionable summary of the most significant finding (e.g., 
      'Pending antitrust litigation - DOJ investigation', 'High dependency on Taiwan semiconductors', 'Recent data breach - 
      ongoing remediation'), or simply state 'None identified' if no material risks are found.
    
    * **Final Risk Suitability Score:** A single number from **1 to 10**, where:
      - **10** = Lowest Qualitative Risk (Highly Suitable)
      - **1** = Unsuitable (High Qualitative Risk - should be excluded)
      - Scores below 5 should trigger reconsideration or exclusion
    
  agent: Risk_Management_Specialist
  context:
    - Quantitative_Defensive_Stock_Filtering
    - market_research_task


Portfolio_Allocation_Task:
  description: >
    Your mission is to construct the **Final Portfolio Allocation Plan**. You must synthesize the data from all preceding stages:
    
    1. **Client Profile JSON:** To understand the client's financial constraints, risk tolerance, goal type, and timeline.
    2. **Market Research Brief:** To confirm the current market outlook and the rationale for sector selection.
    3. **Risk Vetting Table (Input Context):** To see the final list of 5-7 quantitatively and qualitatively approved stock candidates.

    Allocate the client's **full available investment capital** (from the Client Profile JSON) among the stocks listed in the 
    risk-vetted input table.

    **Your specific process must include:**

    1. **Goal-Based Weighting (Dynamic):** Design the allocation weights (%) based directly on the client's 
       **'verified_risk_tolerance_score'** and **'primary_goal_type'**.
       
       * **For Growth Goals:** 
         - Strongly favor candidates/sectors with **BULLISH** sentiment and potential high returns
         - Acceptable to have concentrated positions (20-30% in top performers)
         - Can accept moderate-to-high volatility
       
       * **For Preservation Goals:** 
         - Strongly favor candidates with the highest **'Risk Suitability Score (8-10)'** and lowest Beta
         - Maximum 15-20% in any single position
         - Prioritize diversification
    
    2. **Sector Compliance & Diversification:** 
       - Ensure the final selection and weights are diversified across at least 2 sectors
       - If the client specified a sector or asset preference (e.g., in the `strategy_preference` like "include ETFs"), 
         ensure the allocation includes a strategic weight for those preferences
       - Limit sector concentration to maximum 50% of total capital
    
    3. **Final Calculation:** 
       - Calculate the exact **Investment Amount ($)** for each stock based on the allocated percentage and the client's 
         total capital
       - **CRITICAL:** Get the current stock price using your tools and calculate the **exact number of shares** 
         (Investment Amount ÷ Current Price)
       - Round shares down to whole numbers
       - Verify total allocation = 100% of capital
  
  expected_output: >
    A complete **Final Portfolio Allocation Plan** formatted clearly in Markdown. The output must consist of three mandatory parts:
    
    ## Part 1: Allocation Strategy Summary
    
    A concise paragraph (3-4 sentences) that states:
    - The overarching allocation philosophy (Growth-focused / Balanced / Defensive)
    - How the weights were determined based on client profile
    - The expected risk/return profile
    
    ## Part 2: Detailed Allocation Table
    
    | Ticker | Stock Name | Sector | Current Price ($) | Allocation (%) | Investment Amount ($) | Shares to Purchase | Risk Suitability Score | Allocation Rationale |
    | :--- | :--- | :--- | ---: | ---: | ---: | ---: | :---: | :--- |
    | AAPL | Apple Inc. | Technology | 263.82 | 20% | 20,000 | 75 | 9 | Core growth position; market leader |
    
    **CRITICAL VALIDATION:**
    - Current Price must be fetched using your Stock Retriver Tool
    - Shares = Investment Amount ÷ Current Price (rounded down)
    - Total Allocation % must equal 100%
    - Total Investment Amount must equal client's stated capital
    
    ## Part 3: Portfolio Composition Summary
    
    - **Total Capital Deployed:** $X,XXX,XXX
    - **Number of Positions:** X
    - **Sector Breakdown:** 
      - Sector A: X%
      - Sector B: X%
    - **Weighted Average Risk Score:** X.X/10
    - **Portfolio Beta:** X.XX (if calculable)
    
  agent: Investment_Strategist
  context:
    - Qualitative_and_External_Risk_Assessment
    - Quantitative_Defensive_Stock_Filtering
    - market_research_task
    - client_profile_task


Final_Report_Task:
  description: >
    Your mission is to act as the final **Report Generator**, converting the structured data from the **Portfolio Allocation Plan** 
    (provided in the preceding task) into a polished, professional, and client-ready **Investment Recommendation Report**.
    
    This report must effectively synthesize the client's initial goals, the **specific investment methodology applied 
    (Growth or Defensive)**, and the final strategic allocation into a coherent, persuasive narrative. Your document must 
    maintain a tone that is **highly professional, trustworthy, analytical, and completely non-promotional**.
    
    Your report must adhere strictly to the following structure and content requirements, drawing context from the entire 
    chain of analysis (Client Profile, Market Brief, Risk Vetting, and Allocation):

    **Required Structure:**

    1. **Executive Summary** 
       - Open with a direct address to the client
       - Confirm the primary investment goal (from Client Profile JSON)
       - State the total capital allocated
       - Describe the strategic objective of the recommended portfolio (e.g., "Aggressive Capital Appreciation with 
         Technology Focus" OR "Capital Preservation with Income Focus")
       - Length: 3-4 sentences

    2. **Strategic Rationale & Methodology**
       - Justify the **specific approach (Growth or Defensive)** chosen
       - Clearly link the client's **verified risk tolerance and timeline** to the filtering and allocation criteria used
       - Explain the sector selection logic (reference Market Research Brief)
       - This section must explain *why* this strategy is the optimal fit for their **timeline and goal type**
       - Include 1-2 sentences on how current market conditions support this approach
       - Length: 2-3 paragraphs (6-8 sentences total)

    3. **Portfolio Recommendation**
       - Re-present the final **Allocation Table** from the Portfolio Allocation Task
       - Must include ALL columns: Ticker, Stock Name, Sector, Current Price, Allocation %, Investment Amount, 
         Shares to Purchase, Risk Suitability Score
       - Include the Portfolio Composition Summary (Total Capital, Sector Breakdown, Weighted Risk Score)

    4. **Security Justifications (Deep Dive)**
       - For *every* stock/ETF in the portfolio, provide a focused **2-3 sentence justification**
       - This justification must reference:
         a) Its verified quantitative strength (from Quantitative Filtering)
         b) Its **Risk Suitability Score** and any notable qualitative risks
         c) Its specific role in the portfolio (e.g., 'Core growth driver', 'Defensive income anchor', 
            'Speculative high-growth position')
       - Format as numbered list with ticker and company name as headers
    
    5. **Risk Disclosure & Monitoring Recommendations** (NEW REQUIRED SECTION)
       - Briefly state 2-3 key portfolio-level risks to monitor
       - Recommend review frequency (e.g., quarterly rebalancing)
       - Mention any candidates with Risk Scores < 8 that warrant closer attention
       - Length: 1 paragraph (3-4 sentences)
    
    6. **Conclusion**
       - Brief closing statement reaffirming alignment with client goals
       - Professional sign-off
       - Length: 2 sentences
    
    **Formatting Requirements:**
    - Use clear Markdown headings (##) for each section
    - Use tables for Portfolio Recommendation
    - Use numbered lists for Security Justifications
    - No placeholder text or "to be completed" statements
    - No internal agent commentary
  
  expected_output: >
    A full, complete, and persuasive **Investment Recommendation Report** in clear Markdown format. The report must use 
    distinct, numbered or bolded headings (##) for all six mandatory sections described above and be ready for immediate 
    delivery to the client. 
    
    DO NOT include any internal commentary, prose introductions, or meta-text outside of the report content itself.
    
    The document should be 800-1200 words and feel like a report from a professional wealth management firm.
    
  agent: Final_Report_Generator
  context:
    - Portfolio_Allocation_Task
    - Qualitative_and_External_Risk_Assessment
    - Quantitative_Defensive_Stock_Filtering
    - market_research_task
    - client_profile_task
